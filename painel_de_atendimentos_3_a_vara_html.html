<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Atendimentos – 3ª Vara da Fazenda Pública – Dra. Etelvina Lobo Braga</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <style>
    body{padding:18px;background:#f7f9fc}
    .card{border-radius:12px}
    textarea{resize:vertical}
    pre.json-out{white-space:pre-wrap;background:#0f1724;color:#d1fae5;padding:12px;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-3">Painel de Atendimentos – 3ª Vara da Fazenda Pública – Dra. Etelvina Lobo Braga</h2>

    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Chave da OpenAI (insira quando abrir; não grave aqui)</label>
          <input id="apiKey" class="form-control" placeholder="sk-..." />
          <div class="form-text">A chave é usada somente na sessão do navegador. Evite colar chaves de produção em computadores públicos.</div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Pergunte sobre os atendimentos</label>
          <div class="input-group">
            <input id="userQuestion" class="form-control" placeholder="Ex.: Quantos atendimentos presenciais houve em outubro?" />
            <button id="askBtn" class="btn btn-primary">Perguntar & Atualizar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-6 mb-3">
        <div class="card p-3">
          <h5>Gráfico: Atendimentos por Setor</h5>
          <div id="chartSector" style="height:320px;"></div>
        </div>
      </div>

      <div class="col-lg-6 mb-3">
        <div class="card p-3">
          <h5>Gráfico: Meio de Atendimento</h5>
          <div id="chartMeio" style="height:320px;"></div>
        </div>
      </div>

      <div class="col-12 mb-3">
        <div class="card p-3">
          <h5>Resposta da IA</h5>
          <div id="aiAnswer" class="mb-2">Nenhuma pergunta feita ainda.</div>
          <details>
            <summary>Dados brutos (amostra)</summary>
            <pre id="rawData" class="json-out"></pre>
          </details>
        </div>
      </div>
    </div>

    <footer class="mt-4 text-muted small">Gerado para uso interno - teste com dados de exemplo. Não deixe sua chave OpenAI em computadores públicos.</footer>
  </div>

<script>
// ===== Dados iniciais (3 registros fornecidos) =====
const data = [
  {
    "NOME": "Ana Paula Benevides",
    "REQUERENTE": "Advogado",
    "NUMERO_DO_PROCESSO": "0403504-55.2023.8.04.0001 (PROJUDI)",
    "SETOR": "Fazenda",
    "MEIO_DE_ATENDIMENTO": "Presencial",
    "ATENDENTE": "Giselle",
    "INFORMACAO_SOLICITACAO": "Solicitação de informação de andamento de processo",
    "PROVIDENCIA": "Advogada solicitou informações acerca do processo. Em consulta aos autos, verificou-se que este se encontra em decurso de prazo. A informação foi repassada à advogada, que tomou ciência e foi orientada a acompanhar os autos pelo site do Tribunal de Justiça. Em diligência interna, confirmou-se que o processo permanece em decurso de prazo, com término em 13/10/2025. Trata-se de: Ação de Indenização por Danos Morais em face do Estado do Amazonas.",
    "ENCAMINHAMENTO": "Rafaela",
    "DATA_DE_ATENDIMENTO": "2025-10-07"
  },
  {
    "NOME": "Rogerio Cavalcanti",
    "REQUERENTE": "Parte",
    "NUMERO_DO_PROCESSO": "0629102-95.2021.8.04.0001 (PROJUDI)",
    "SETOR": "NATJUS",
    "MEIO_DE_ATENDIMENTO": "Telefone",
    "ATENDENTE": "Giselle",
    "INFORMACAO_SOLICITACAO": "Solicitação de expedição de documentos em geral",
    "PROVIDENCIA": "Advogada solicitou informações acerca do processo. Em consulta aos autos, verificou-se que este se encontra em fila para expediçao de RPV. A informação foi repassada ao advogado, que tomou ciência e foi orientado a acompanhar os autos pelo site do Tribunal de Justiça. Em diligência interna, confirmou-se que o processo encontra-se na fila para expedição de RPV. Trata-se de: Execução contratual em face do Estado do Amazonas.",
    "ENCAMINHAMENTO": "Luandy",
    "DATA_DE_ATENDIMENTO": "2025-10-05"
  },
  {
    "NOME": "Djane Oliveira",
    "REQUERENTE": "Parte",
    "NUMERO_DO_PROCESSO": "0268264-36.2025.8.04.1000 (PROJUDI)",
    "SETOR": "Fazenda",
    "MEIO_DE_ATENDIMENTO": "Email",
    "ATENDENTE": "Giselle",
    "INFORMACAO_SOLICITACAO": "Realização de atendimento agendado com a magistrada",
    "PROVIDENCIA": "Atendimento com início às 10:52 e término às 10:57",
    "ENCAMINHAMENTO": "Dra. Etelvina",
    "DATA_DE_ATENDIMENTO": "2025-10-02"
  }
];

// Mostrar dados brutos
document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);

function countBy(field, dataset){
  const map = {};
  dataset.forEach(r => { const k = r[field] || 'N/A'; map[k] = (map[k]||0)+1 });
  return Object.keys(map).map(k=>({key:k, value:map[k]})).sort((a,b)=>b.value-a.value);
}

function renderCharts(dataset){
  const bySector = countBy('SETOR', dataset);
  const byMeio = countBy('MEIO_DE_ATENDIMENTO', dataset);

  const sectorTrace = { x: bySector.map(d=>d.key), y: bySector.map(d=>d.value), type:'bar', marker:{}};
  Plotly.newPlot('chartSector',[sectorTrace],{margin:{t:30},yaxis:{title:'Quantidade'}});

  const meioTrace = { labels: byMeio.map(d=>d.key), values: byMeio.map(d=>d.value), type:'pie' };
  Plotly.newPlot('chartMeio',[meioTrace],{margin:{t:30}});
}

renderCharts(data);

// ===== Integração com OpenAI (cliente) =====
async function askOpenAI(apiKey, userQuestion, dataset){
  if(!apiKey) throw new Error('Chave da OpenAI não informada.');

  // Enviar um prompt claro: pedir resposta textual e instruções de filtro/visualização em JSON
  const system = `Você é um assistente analítico que recebe dados de atendimentos. Responda em PORTUGUÊS. Produza um objeto JSON com duas chaves: \n1) answer_text - explicação curta e direta da resposta; \n2) filter - objeto opcional com {field, value} que indica como filtrar o dataset (ou null se não filtrar); \n3) chart - sugestão de gráfico a atualizar {type: 'bar'|'pie'|'table'|'none', xField, yField} (pode ser null). \nNÃO escreva nada além do JSON puro. \nExemplo de saída: {\"answer_text\":\"Houve 10 atendimentos presenciais.\", \"filter\":{\"field\":\"MEIO_DE_ATENDIMENTO\",\"value\":\"Presencial\"}, \"chart\":{\"type\":\"bar\",\"xField\":\"SETOR\",\"yField\":\"count\"}}`;

  const user = `Dados (apenas para consulta): ${JSON.stringify(dataset)}\n\nPergunta: ${userQuestion}\n\nResponda seguindo o formato JSON proposto.`;

  const payload = {
    model: 'gpt-4o-mini',
    messages: [
      {role:'system', content: system},
      {role:'user', content: user}
    ],
    max_tokens: 400,
    temperature: 0.1
  };

  const resp = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`
    },
    body: JSON.stringify(payload)
  });

  if(!resp.ok){
    const txt = await resp.text();
    throw new Error('Erro OpenAI: '+txt);
  }
  const j = await resp.json();
  // Extrair texto de resposta
  const text = j.choices?.[0]?.message?.content || '';
  return text;
}

function safeJsonParse(s){
  try{ return JSON.parse(s); }catch(e){ return null; }
}

async function handleQuestion(){
  const apiKey = document.getElementById('apiKey').value.trim();
  const q = document.getElementById('userQuestion').value.trim();
  if(!q){ alert('Digite uma pergunta.'); return; }
  document.getElementById('askBtn').disabled = true;
  document.getElementById('aiAnswer').textContent = 'A IA está respondendo...';

  try{
    const raw = await askOpenAI(apiKey, q, data);
    // Tentar extrair JSON puro do retorno
    let parsed = safeJsonParse(raw);
    if(!parsed){
      // Tentar localizar o primeiro {...} no texto
      const m = raw.match(/\{[\s\S]*\}/);
      if(m) parsed = safeJsonParse(m[0]);
    }

    if(!parsed){
      // Se falhar, mostra o texto cru como resposta
      document.getElementById('aiAnswer').textContent = 'Resposta (não-JSON): ' + raw;
    } else {
      document.getElementById('aiAnswer').textContent = parsed.answer_text || 'Sem texto explicativo.';

      // Aplicar filtro se houver
      let dataset = data;
      if(parsed.filter && parsed.filter.field && parsed.filter.value){
        dataset = data.filter(r => String(r[parsed.filter.field]||'').toLowerCase().includes(String(parsed.filter.value).toLowerCase()));
        document.getElementById('rawData').textContent = JSON.stringify(dataset, null, 2);
      } else {
        document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
      }

      // Atualizar gráfico sugerido
      if(parsed.chart && parsed.chart.type){
        if(parsed.chart.type === 'bar'){
          const byX = countBy(parsed.chart.xField || 'SETOR', dataset);
          const trace = { x: byX.map(d=>d.key), y: byX.map(d=>d.value), type:'bar' };
          Plotly.newPlot('chartSector',[trace],{margin:{t:30}});
        } else if(parsed.chart.type === 'pie'){
          const byX = countBy(parsed.chart.xField || 'MEIO_DE_ATENDIMENTO', dataset);
          const trace = { labels: byX.map(d=>d.key), values: byX.map(d=>d.value), type:'pie' };
          Plotly.newPlot('chartMeio',[trace],{margin:{t:30}});
        }
      } else {
        // re-render default
        renderCharts(dataset);
      }
    }
  }catch(err){
    console.error(err);
    document.getElementById('aiAnswer').textContent = 'Erro: ' + err.message;
  }
  document.getElementById('askBtn').disabled = false;
}

// Eventos
document.getElementById('askBtn').addEventListener('click', handleQuestion);
document.getElementById('userQuestion').addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleQuestion(); });

</script>
</body>
</html>
